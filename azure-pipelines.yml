trigger: none  # Manual trigger only (no automatic runs)

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: sedstart-secrets  # Reuse your existing variable group that contains GITHUB_PAT
  # Your GITHUB_PAT (classic token with 'repo' scope) works for both repos

steps:
  - task: Bash@3
    displayName: 'Dispatch Suite.yml Workflow in Smoke Repository'
    inputs:
      targetType: 'inline'
      script: |
        echo "Dispatching workflow: Suite.yml on branch main in AbdullahB2002/Smoke"

        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          "https://api.github.com/repos/AbdullahB2002/Smoke/actions/workflows/Suite.yml/dispatches" \
          -H "Authorization: token $(GITHUB_PAT)" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -d '{
            "ref": "main"
          }')

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        echo "##[section]GitHub Dispatch Response (HTTP $HTTP_CODE):"
        echo "$BODY"

        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "✅ Success! Suite.yml workflow dispatched successfully!"
          echo "View the workflow run here:"
          echo "https://github.com/AbdullahB2002/Smoke/actions/workflows/Suite.yml"
        else
          echo "❌ Dispatch failed with HTTP $HTTP_CODE"
          echo "Common fixes:"
          echo "   • Workflow file name is exactly 'Suite.yml' (case-sensitive: capital S)"
          echo "   • File exists on the 'main' branch"
          echo "   • GITHUB_PAT is a classic token with 'repo' scope"
          echo "   • Suite.yml contains 'on: workflow_dispatch:'"
          echo "   • You have write access to the Smoke repository"
          exit 1
        fi
    env:
      GITHUB_PAT: $(GITHUB_PAT)